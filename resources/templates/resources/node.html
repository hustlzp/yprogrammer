{% extends 'base.html' %}

{% block page_id %}page-node{% endblock %}
{% block page_title %}{{ node.Title }}{% endblock %}
{% block body %}

<script type="text/javascript">
$(function(){
   $('.btn-collect, .btn-discollect').click(function(){
      var r_id = $(this).data('resource-id');
      
      if($(this).hasClass('btn-collect')){
         var url = "{% url 'collect_resource' %}";
      } else {
         var url = "{% url 'discollect_resource' %}";
      }

      var btn_collect = $(this);

      $.ajax({
         url: url,
         method: 'POST',
         data: { 'r_id': r_id },
         success: function(result){
            if(result === 'success'){
               var collect_count = $(btn_collect).nextAll('.collect-count');

               if($(btn_collect).hasClass('btn-collect')){
                  $(btn_collect).parent().addClass('on');
                  collect_count.text(parseInt(collect_count.text()) + 1);
               } else {
                  $(btn_collect).parent().removeClass('on');
                  collect_count.text(parseInt(collect_count.text()) - 1);
               }               
            }
            else if(result === 'unlogin'){
               window.location = "{% url 'index' %}";
            }
         }
      });
   });
   
   // follow & disfollow a node
   $('.btn-follow, .btn-disfollow').click(function(){
      var n_id = $(this).data('node-id');
      
      if($(this).hasClass('btn-follow')){
         var url = "{% url 'follow_node' %}";
      } else {
         var url = "{% url 'disfollow_node' %}";
      }

      var btn_follow = $(this);

      $.ajax({
         url: url,
         method: 'POST',
         data: { 'n_id': n_id },
         success: function(result){
            if(result === 'success'){
               var follow_count = $(btn_follow).nextAll('.follow-count')

               if($(btn_follow).hasClass('btn-follow')){
                  $(btn_follow).parent().addClass('on');
                  $(follow_count).text(parseInt($(follow_count).text()) + 1)
               } else {
                  $(btn_follow).parent().removeClass('on');
                  $(follow_count).text(parseInt($(follow_count).text()) - 1)
               }               
            }
            else if(result === 'unlogin'){
               window.location = "{% url 'index' %}";
            }
         }
      });
   });

});
</script>

<div class="row">
   <div class="span8">
      <div class="page-header">
         <h3>{{ node.title }}</h3>
         <div class='node-desc'>{{ node.desc }}</div>
         <img class='node-image corner' src="{{ node.image_url }}">
      </div>

      <div class='btn-group display-mode' data-toggle="buttons-radio">
         <a class='btn btn-small active' href="#">时间</a>
         <a class='btn btn-small' href="#">人气</a>
         <a class='btn btn-small' href="#">类别</a>
      </div>

      {% for rt in resource_types %}
      <div class='rt-item'>
         <div class='rt-type'>{{ rt.type }}</div>

         {% for r in rt.resources %}
         <div class='res-item'>
            <div class="res-header">
               <img class='res-favicon' src="http://g.etfv.co/{{ r.url }}">
               <a href="{{ r.url }}" class='res-title' target='_blank'>{{ r.title }}</a>
               <small class="res-desc">{{ r.desc }}</small>
            </div>



            <div class='res-meta'>
               <!-- <span class='meta-item'>
                  <span title='类型：{{ r.type }}'>{{ r.type.type }}</span>
               </span> -->
               <span class='meta-item'>
                  <i class='icon-user'></i> <a href="{% url 'user' r.creator.name %}">{{ r.creator.name }}</a>
               </span>
               <span class='meta-item'>
                  <i class='icon-comment-alt'></i> <a href="{% url 'resource' r.id %}">8评论</a>
               </span>
               <!-- <span class='meta-item'>36分钟前</span> -->
               <span class='meta-item res-thank'><i class='icon-heart-empty'></i> <a href='#'>感谢</a></span>
               <span class='meta-item res-thank'><i class='icon-share'></i> <a href='#'>分享</a></span>
            </div>

            <div class='btn-group collect-wap {% if r.is_collected %}on{% endif %}'>
               <a class="btn btn-mini btn-primary btn-discollect" data-resource-id='{{ r.id }}' title='取消导航'><i class='icon-bookmark'></i></a>
               <a class="btn btn-mini btn-collect" data-resource-id='{{ r.id }}' title='添加到导航'><i class='icon-bookmark-empty'></i></a>
               <a class='btn btn-mini collect-count'>{{ r.collect_count }}</a>
            </div>
         </div>
         {% endfor %}
      </div>
      {% endfor %}
   </div>

   <div class="span4">
      <div class="btn-toolbar">
         <div class='btn-group follow-container {% if is_followed %}on{% endif %}'>
            <a class="btn btn-follow" data-node-id='{{ node.id }}' title='关注'><i class='icon-ok'></i></a>a
            <a class="btn btn-primary btn-disfollow" data-node-id='{{ node.id }}' title='取消关注'><i class='icon-ok'></i></a>
            <a class='btn follow-count'>{{ follow_count }}</a>
         </div>

         <a class="btn btn-primary" href="#"><i class='icon-plus'></i> 添加资源</a>
      </div>
      
      <div class="sidebar-header">
         <h4></h4>
      </div>
   </div>
</div>

{% endblock %}