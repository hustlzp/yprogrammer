{% extends 'base.html' %}

{% block page_id %}page-node{% endblock %}
{% block page_title %}{{ node.Title }}{% endblock %}
{% block body %}

{% load is_followed from resource_tags %}
{% load is_collected from resource_tags %}

<script type="text/javascript">
$(function(){
   // collect resource by Ajax
   $('.btn-collect').one('click', function(){
      var r_id = $(this).data('resource-id');
      var url = "{% url 'collect_resource' %}";
      var btn_collect = $(this);

      ajax_collect_resource(url, r_id, function(){
         var collect_count = $(btn_collect).nextAll('.collect-count');
         $(btn_collect).parent().addClass('on');
         collect_count.text(parseInt(collect_count.text()) + 1);
      });
   });

   // discollect resource by Ajax
   $('.btn-discollect').one('click', function(){
      var r_id = $(this).data('resource-id');
      var url = "{% url 'discollect_resource' %}";
      var btn_discollect = $(this);

      ajax_collect_resource(url, r_id, function(){
         var collect_count = $(btn_discollect).nextAll('.collect-count');
         $(btn_discollect).parent().removeClass('on');
         collect_count.text(parseInt(collect_count.text()) - 1);
      });
   });

   // follow node by Ajax
   $('.btn-follow').click(function(){
      var n_id = $(this).data('node-id');
      var url = "{% url 'follow_node' %}";
      var btn_follow = $(this);

      ajax_follow_node(url, n_id, function(){
         var follow_count = $(btn_follow).nextAll('.follow-count');
         $(btn_follow).parent().addClass('on');
         $(follow_count).text(parseInt($(follow_count).text()) + 1);
      });
   });

   // disfollow node by Ajax
   $('.btn-disfollow').click(function(){
      var n_id = $(this).data('node-id');
      var url = "{% url 'disfollow_node' %}";
      var btn_disfollow = $(this);

      ajax_follow_node(url, n_id, function(){
         var follow_count = $(btn_disfollow).nextAll('.follow-count');
         $(btn_disfollow).parent().removeClass('on');
         $(follow_count).text(parseInt($(follow_count).text()) - 1);
      });
   });
});
</script>

<div class="row">
   <div class="span8">
      <div class="page-header">
         <h3>{{ node.title }}</h3>
         <div class='node-desc'>{{ node.desc }}</div>
         <img class='node-image corner' src="{{ node.image_url }}">
      </div>

      <div class='btn-group display-mode' data-toggle="buttons-radio">
         <a class="btn btn-small {% if mode == 'time' %}active{% endif %}" href="{% url 'node' node.id %}?mode=time">时间</a>
         <a class="btn btn-small {% if mode == 'popular' %}active{% endif %}" href="{% url 'node' node.id %}?mode=popular">人气</a>
         <a class="btn btn-small {% if mode == 'type' %}active{% endif %}" href="{% url 'node' node.id %}?mode=type">类别</a>
      </div>

      {% for rt in resource_types %}
      <div class='rt-item'>
         <div class='rt-type'>{{ rt.type }}</div>
         {% include 'resources.tpl' with resources=rt.resources %}
      </div>
      {% endfor %}

      {% include 'resources.tpl' with resources=resources %}
   </div>

   <div class="span4">
      <div class="btn-toolbar">
         <div class='btn-group follow-container {% if node|is_followed:request.session.user_id %}on{% endif %}'>
            <a class="btn btn-follow" data-node-id='{{ node.id }}' title='关注'><i class='icon-ok'></i></a>a
            <a class="btn btn-primary btn-disfollow" data-node-id='{{ node.id }}' title='取消关注'><i class='icon-ok'></i></a>
            <a class='btn follow-count'>{{ node.follow_count }}</a>
         </div>

         <!-- <a class="btn btn-primary" href="#"><i class='icon-plus'></i> 添加资源</a> -->
      </div>
      
<!--       <div class="sidebar-header">
         <h4>类别</h4>
         <ul class='resource-type-list'>
            {% for rt in resource_types %}
            <li><a href='#'>{{ rt.type }} {{ rt.resources|length }}</a></li>
            {% endfor %}
         </ul>
      </div> -->
   </div>
</div>

{% endblock %}